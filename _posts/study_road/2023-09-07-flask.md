---
layout:       post
title:        "Flask框架"
author:       "Andy"
header-style: text
catalog:      true
tags:
    - flask
    - python
    - web
---

## hello world
```
from flask import Flask
 
app = Flask(__name__)
 
@app.route('/')
def hello_world():
    return 'Hello World!'
 
if __name__ == '__main__':
    app.run()
```

## 获取URL参数
server:
```
from flask import Flask, request
 
app = Flask(__name__)
 
 
@app.route('/')
def hello_world():
    return request.args.__str__()
 
 
if __name__ == '__main__':
    app.run(port=5000, debug=True)
```





## 上传文件
> 使用POST方法

server code
```
from flask import Flask, request
 
from werkzeug.utils import secure_filename
import os
 
app = Flask(__name__)
  
# 文件上传的大小  
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024 #16MB
# 文件上传目录
app.config['UPLOAD_FOLDER'] = 'static/'
# 支持的文件格式
app.config['ALLOWED_EXTENSIONS'] = {'png', 'jpg', 'jpeg', 'gif'}  # 集合类型
 
 
# 判断文件名是否是我们支持的格式
def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1] in app.config['ALLOWED_EXTENSIONS']
 
 
@app.route('/')
def hello_world():
    return 'hello world'
 
 
@app.route('/upload', methods=['POST'])
def upload():
    upload_file = request.files['image']
    if upload_file and allowed_file(upload_file.filename):
        filename = secure_filename(upload_file.filename)
        # 将文件保存到 static/uploads 目录，文件名同上传时使用的文件名
        upload_file.save(os.path.join(app.root_path, app.config['UPLOAD_FOLDER'], filename))
        return 'info is '+request.form.get('info', '')+'. success'
    else:
        return 'failed'
 
 
if __name__ == '__main__':
    app.run(debug=True)
```
upload_file.save(path)用来将upload_file保存在服务器的文件系统中，参数最好是绝对路径，否则会报错

clint code
```
import requests
 
file_data = {'image': open('Andy.jpg', 'rb')}
 
user_info = {'info': 'Andy'}
 
r = requests.post("http://127.0.0.1:5000/upload", data=user_info, files=file_data)
 
print(r.text)
```

## 编码转换
server code
```
@app.route('/user/<username>')
def user(username):
    print(username)
    print(type(username))
    return 'hello ' + username
 
 
@app.route('/user/<username>/friends')
def user_friends(username):
    print(username)
    print(type(username))
    return 'hello ' + username
```

http://127.0.0.1:5000/user/andy
http://127.0.0.1:5000/user/andy/friends
输出：
```
andy
<class 'str'>
```

- 加入类型转换器：
```
@app.route('/page/<int:num>')
def page(num):
    print(num)
    print(type(num))
    return 'hello world'
```

http://127.0.0.1:5000/page/1
输出：
```
1
<class 'int'>
```

- 3个默认转换器
```
int     accepts integers
float     like int but for floating point values
path     like the default but also accepts slashes
```

server code
```
@app.route('/page/<int:num1>-<int:num2>')
def page(num1, num2):
    print(num1)
    print(num2)
    return 'hello world'
```
http://127.0.0.1:5000/page/11-22
输出：
```
11
22
```

## url_for生成链接
server code
```
from flask import Flask, url_for

app = Flask(__name__)


@app.route('/')
def hello_world():
    pass


@app.route('/user/<name>')
def user(name):
    pass


@app.route('/page/<int:num>')
def page(num):
    pass


@app.route('/test')
def test():
    print(url_for('hello_world'))
    print(url_for('user', name='Andy'))
    print(url_for('page', num=1, q='hadoop mapreduce 10%3'))
    print(url_for('static', filename='uploads/01.jpg'))
    return 'Hello'


if __name__ == '__main__':
    app.run(debug=True)
```
http://127.0.0.1:5000/test
输出：
```
/
/user/Andy
/page/1?q=hadoop+mapreduce+10%253
/static/uploads/01.jpg
```

## redirect重定向
server code
```
from flask import Flask, url_for, redirect
 
app = Flask(__name__)
 
@app.route('/')
def hello_world():
    return 'hello world'
 
@app.route('/test1')
def test1():
    print('this is test1')
    return redirect(url_for('test2'))
 
@app.route('/test2')
def test2():
    print('this is test2')
    return 'this is test2'
 
if __name__ == '__main__':
    app.run(debug=True)
```
http://127.0.01:5000/test1
输出：
```
this is test2
```

## Jinja2模板
> Jinja2是Flask默认的模板引擎，它是基于Python的模板引擎，它的语法和Django模板引擎的语法类似。Jinja2模板引擎的语法请见 http://docs.jinkan.org/docs/jinja2/ 。

[模版](https://blog.csdn.net/sinat_38682860/article/details/82354342?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169389630916800213083889%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=169389630916800213083889&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-82354342-null-null.142^v93^insert_down1&utm_term=flask&spm=1018.2226.3001.4187)

app_py
```
from flask import Flask, render_template

app = Flask(__name__)


@app.route('/')
def hello_world():
    return 'hello world'


@app.route('/user')
def user():
    user_info = {
        'name': 'Andy',
        'email': '123@aa.com',
        'age': 21,
        'github': 'https://github.com/andy-boy123'
    }
    return render_template('user_info.html', page_title='Andy\'s info', user_info=user_info)


if __name__ == '__main__':
    app.run(port=5000, debug=True)
```
http://127.0.0.1:5000/user

网页源码：
```
<html>
<head>
    <title>
        Andy's info
    </title>
</head>
<body>
    name: Andy 
    email:123@aa.com
    age: 21
    github:https://github.com/andy-boy123
</body>
</html>
```

## 自定义404等页面

401未登录：
```
from flask import Flask, render_template_string, abort
 
app = Flask(__name__)
 
 
@app.route('/')
def hello_world():
    return 'hello world'
 
 
@app.route('/user')
def user():
    abort(401)  # Unauthorized 未授权
    print('Unauthorized, 请先登录')
 
 
if __name__ == '__main__':
    app.run(port=5000, debug=True)
```

```
from flask import Flask, render_template_string, abort
 
app = Flask(__name__)
 
 
@app.route('/')
def hello_world():
    return 'hello world'
 
 
@app.route('/user')
def user():
    abort(401)  # Unauthorized
 
 
@app.errorhandler(401)
def page_unauthorized(error):
    return render_template_string('<h1> Unauthorized </h1><h2>{{ error_info }}</h2>', error_info=error), 401
 
 
if __name__ == '__main__':
    app.run(port=5000, debug=True)
```
page_unauthorized函数返回的是一个元组，401 代表HTTP 响应状态码。如果省略401，则响应状态码会变成默认的 200。

## 用户会话

```
from flask import Flask, render_template_string, \
    session, request, redirect, url_for
 
app = Flask(__name__)
 
app.secret_key = 'F12Zr47j\3yX R~X@H!jLwf/T'
 
 
@app.route('/')
def hello_world():
    return 'hello world'
 
 
@app.route('/login')
def login():
    page = '''
    <form action="{{ url_for('do_login') }}" method="post">
        <p>name: <input type="text" name="user_name" /></p>
        <input type="submit" value="Submit" />
    </form>
    '''
    return render_template_string(page)
 
 
@app.route('/do_login', methods=['POST'])
def do_login():
    name = request.form.get('user_name')
    session['user_name'] = name
    return 'success'
 
 
@app.route('/show')
def show():
    return session['user_name']
 
 
@app.route('/logout')
def logout():
    session.pop('user_name', None)
    return redirect(url_for('login'))
 
 
if __name__ == '__main__':
    app.run(port=5000, debug=True)
```

app.secret_key用于给session加密。

在/login中将向用户展示一个表单，要求输入一个名字，submit后将数据以post的方式传递给/do_login，/do_login将名字存放在session中。

如果用户成功登录，访问/show时会显示用户的名字。此时，打开firebug等调试工具，选择session面板，会看到有一个cookie的名称为session。

/logout用于登出，通过将session中的user_name字段pop即可。Flask中的session基于字典类型实现，调用pop方法时会返回pop的键对应的值；如果要pop的键并不存在，那么返回值是pop()的第二个参数。

另外，使用redirect()重定向时，一定要在前面加上return。

进入http://127.0.0.1:5000/login，输入name，点击submit：

进入http://127.0.0.1:5000/show查看session中存储的name：



设置session的过期时间：
```
from datetime import timedelta
from flask import session, app
 
session.permanent = True
app.permanent_session_lifetime = timedelta(minutes=5)
```

## 使用cookie
>Cookie是存储在客户端的记录访问者状态的数据。具体原理，请见 http://zh.wikipedia.org/wiki/Cookie 。 常用的用于记录用户登录状态的session大多是基于cookie实现的。

cookie可以借助flask.Response来实现

```
from flask import Flask, request, Response, make_response
import time
 
app = Flask(__name__)
 
 
@app.route('/')
def hello_world():
    return 'hello world'
 
 
@app.route('/add')
def login():
    res = Response('add cookies')
    res.set_cookie(key='name', value='1234', expires=time.time()+6*60)
    return res
 
 
@app.route('/show')
def show():
    return request.cookies.__str__()
 
 
@app.route('/del')
def del_cookie():
    res = Response('delete cookies')
    res.set_cookie('name', '', expires=0)
    return res
 
 
if __name__ == '__main__':
    app.run(port=5000, debug=True)
```
可以使用Response.set_cookie添加和删除cookie。expires参数用来设置cookie有效时间，它的值可以是datetime对象或者unix时间戳,此处使用的是unix时间戳
```
res.set_cookie(key='name', value='letian', expires=time.time()+6*60)
```
expire参数值表示cookie在6分钟后过期。
要删除cookie，只需要将expires设置为0即可
```
res.set_cookie('name', '', expires=0)
```

## 闪存系统 flashing system
>闪存系统是一种临时存储数据的机制，它可以在一次请求中存储信息，然后在另一次请求中读取信息。闪存系统是基于session实现的，它的原理是将数据存储在session中，然后在下一次请求中将数据从session中删除。

```
from flask import Flask, flash, get_flashed_messages
import time
 
app = Flask(__name__)
app.secret_key = 'some_secret'
 
 
@app.route('/')
def index():
    return 'hi'
 
 
@app.route('/gen')
def gen():
    info = 'access at '+ time.time().__str__()
    flash(info)
    return info
 
 
@app.route('/show1')
def show1():
    return get_flashed_messages().__str__()
 
 
@app.route('/show2')
def show2():
    return get_flashed_messages().__str__()
 
 
if __name__ == "__main__":
    app.run(port=5000, debug=True)
```
打开浏览器，访问http://127.0.0.1:5000/gen
```
access at 1694068052.5214832
```
打开浏览器，访问http://127.0.0.1:5000/gen
```
access at 1694068064.4610322
```
使用浏览器访问http://127.0.0.1:5000/show1
```
['access at 1694068052.5214832', 'access at 1694068064.4610322']
```
http://127.0.0.1:5000/show2
```
[]
```

flash分类（category）：
```
from flask import Flask, flash, get_flashed_messages
import time

app = Flask(__name__)

app.secret_key = 'some_secret'


@app.route('/')
def index():
    return 'hi'
 
 
@app.route('/gen')
def gen():
    info = 'access at '+ time.time().__str__()  #获取当前时间
    flash('show1 '+info, category='show1')    #分类1
    flash('show2 '+info, category='show2')    #分类2
    return info
 
#只显示分类1
@app.route('/show1')
def show1():
    return get_flashed_messages(category_filter='show1').__str__()
 
#只显示分类2
@app.route('/show2')
def show2():
    return get_flashed_messages(category_filter='show2').__str__()
 
 
if __name__ == "__main__":
    app.run(port=5000, debug=True)
```